(function(){var a;window.FirebasePassportLogin=function(b,c){"use strict";function d(a,b,c,d){let e=void 0===window.screenLeft?screen.left:window.screenLeft,f=void 0===window.screenTop?screen.top:window.screenTop,g=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,h=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,i=window.open(a,b,"scrollbars=yes, width="+c+", height="+d+", top="+(h/2-d/2+f)+", left="+(g/2-c/2+e));return window.focus&&i.focus(),i}function e(b){let c=m._ref.child(b);a.set("passportAnonymous",m._anonymousUid,{secure:0===document.location.href.indexOf("https")}),g("listening for firebase auth token at "+c.toString()),c.on("value",function(b){let d,e=b.val();try{d=JSON.parse(e)}catch(a){g("Error parsing payload: "+(a.message||"unknown"))}if(d&&d.token){g("Auth Token: "+d.token),g("Auth User: "+JSON.stringify(d.user,0,2)),a.remove("passportAnonymous"),c.off(),c.remove();try{m._oAuthWindow.close()}catch(a){console.error(a)}f(d)}})}function f(b){return b&&b.token?m._firebaseApp.auth().signOut().then(function(){return m._firebaseApp.auth().signInWithCustomToken(b.token)}).then(function(){let c=b.user;c&&(c[c.provider]={cachedUserProfile:JSON.parse(c.thirdPartyUserData)},c.token=b.token,c.thirdPartyUserData=void 0,m._opts.removeTokensImmediately?a.set("passportSession",""):a.set("passportSession",b.token),m._callback(null,c))}).catch(function(b){"EXPIRED_TOKEN"===b.code&&a.set("passportSession",""),m._callback(b)}):void 0}function g(){m._opts.debug&&("function"==typeof m._opts.debug?m._opts.debug.apply(this,Array.from(arguments)):window.console&&console.log.apply(console,Array.from(arguments)))}function h(a){return m._opts.tokenPath+"/"+a}function i(a){let b;g("Message: "+JSON.stringify(a,0,2));try{b=JSON.parse(a.data)}catch(a){}b&&"init"===b.type&&b.redirect&&m._redirectURL!==b.redirect&&(m._redirectURL=b.redirect)}function j(a){if(g("firebase-passport-login idTokenChange user="+(a?(a.isAnonymous?"anonymous":"non-anonymous")+" uid="+a.uid:"n/a")),m._currentUser=a,a&&a.isAnonymous)m._anonymousUid=a.uid;else if(!m._opts.preserveAuth||!a)return m.forceAnonymousReauth()}function k(){g(`client/firebase-passport-login.js:_init: ${window.document.location.href}`),a=a||l();let b=m._firebaseApp.auth().currentUser;b&&(g({curUser:b},"FirebasePassportLogin._init()"),Promise.resolve(b&&b.getIdToken()).then(function(a){m._callback(null,{token:a,provider:b.providerData,uid:b.uid})})),g("passportSession = "+a.get("passportSession")),window.addEventListener("message",i),Promise.resolve().then(function(){if(m._opts.forceAnonymousReauth)return m.forceAnonymousReauth()}).then(function(){m._tokenChangeUnsubscribe=m._firebaseApp.auth().onIdTokenChanged(j)})}function l(){let e={};return!function(m,n){var b=function(){return b.get.apply(b,arguments)},o=b.utils={isArray:Array.isArray||function(b){return"[object Array]"===Object.prototype.toString.call(b)},isPlainObject:function(b){return!!b&&"[object Object]"===Object.prototype.toString.call(b)},toArray:function(b){return Array.prototype.slice.call(b)},getKeys:Object.keys||function(d){var a=[],b="";for(b in d)d.hasOwnProperty(b)&&a.push(b);return a},encode:function(b){return(b+"").replace(/[,;"\\=\s%]/g,function(b){return encodeURIComponent(b)})},decode:function(b){return decodeURIComponent(b)},retrieve:function(c,a){return null==c?a:c}};b.defaults={},b.expiresMultiplier=86400,b.set=function(a,b,c){if(o.isPlainObject(a))for(var d in a)a.hasOwnProperty(d)&&this.set(d,a[d],b);else{c=o.isPlainObject(c)?c:{expires:c};var e=c.expires===n?this.defaults.expires||"":c.expires,g=typeof e;"string"==g&&""!==e?e=new Date(e):"number"==g&&(e=new Date(+new Date+1e3*this.expiresMultiplier*e)),""!==e&&"toGMTString"in e&&(e=";expires="+e.toGMTString());var i=c.path||this.defaults.path;i=i?";path="+i:"";var p=c.domain||this.defaults.domain;p=p?";domain="+p:"";var q=c.secure||this.defaults.secure?";secure":"";!1===c.secure&&(q=""),m.cookie=o.encode(a)+"="+o.encode(b)+e+i+p+q}return this},b.setDefault=function(c,a){if(o.isPlainObject(c)){for(var d in c)this.get(d)===n&&this.set(d,c[d],a);return b}return this.get(c)===n?this.set.apply(this,arguments):void 0},b.remove=function(d){d=o.isArray(d)?d:o.toArray(arguments);for(var e=0,f=d.length;e<f;e++)this.set(d[e],"",-1);return this},b.removeSpecific=function(d,f){if(!f)return this.remove(d);d=o.isArray(d)?d:[d],f.expires=-1;for(var b=0,g=d.length;b<g;b++)this.set(d[b],"",f);return this},b.empty=function(){return this.remove(o.getKeys(this.all()))},b.get=function(d,a){var b=this.all();if(o.isArray(d)){for(var c,i={},e=0,j=d.length;e<j;e++)c=d[e],i[c]=o.retrieve(b[c],a);return i}return o.retrieve(b[d],a)},b.all=function(){if(""===m.cookie)return{};for(var a=m.cookie.split("; "),b={},c=0,d=a.length;c<d;c++){var f=a[c].split("="),g=o.decode(f.shift()),h=o.decode(f.join("="));b[g]=h}return b},b.enabled=function(){if(navigator.cookieEnabled)return!0;var c="_"===b.set("_","_").get("_");return b.remove("_"),c},"function"==typeof define&&define.amd?define(function(){return{cookie:b}}):e.cookie=b}("undefined"==typeof document?null:document),e.cookie}const m=this;var n=!1;m._opts=Object.assign({removeTokensImmediately:!1,authWindowWidth:1024,authWindowHeight:650,redirectURL:null,tokenPath:"oAuth/login",forceAnonymousReauth:!1,preserveAuth:!0,debug:!1},b||{});try{n=window.localStorage&&localStorage["firebase-passport-login-debug-mode"]}catch(a){}if(m._opts.debug=m._opts.debug||n,m._firebaseApp=m._opts.firebaseApp,m._firebaseDB=m._firebaseApp.database(),m._firebaseURL=m._opts.firebaseConfig.databaseURL,m._ref=m._firebaseDB.ref(),m._oAuthServerWindow={width:m._opts.authWindowWidth,height:m._opts.authWindowHeight},m._callback=c,m._ready=!0,m._redirectURL=m._opts.redirectURL,!m._opts.firebaseApp||!m._opts.authURL)throw new Error("Required option(s) missing, one or more of authUrl, firebaseApp and/or firebaseConfig");if(m._opts.debug){window.firebasePassportLoginObject=m;var o=Object.assign({},m._opts,{firebaseApp:"object"==typeof m._opts.firebaseApp?"[object]":m._opts.firebaseApp});g("FirebasePassportLogin Options:\n"+JSON.stringify(o,0,2))}m.forceAnonymousReauth=function(){return m._firebaseApp.auth().signInAnonymously().then(function(a){m._anonymousUid=a.user.uid,m._currentUser=a.user}).catch(function(){throw new Error("Anonymous login failed. Make sure Anonymous login is enabled in your Firebase")})},m.startAnonymousAuthConnection=function(){},m.login=function(a){return g("Login with "+a+" being attempted with uid \""+(m._anonymousUid||"n/a")+"\""),m._provider=a,m._anonymousUid?m._login():m.forceAnonymousReauth().then(m._login)},m._login=function(){let a=h(m._anonymousUid);e(a);let b=m._opts.authURL+m._provider+"?oAuthTokenPath="+a+"&redirect="+encodeURIComponent(m._redirectURL);m._firebaseURL&&(b+="&firebaseURL="+encodeURIComponent(m._firebaseURL)),m._oAuthWindow=d(b,"_blank",m._oAuthServerWindow.width,m._oAuthServerWindow.height)},m.logout=function(){let b=a.get("passportSession");b&&m._opts.removeTokensImmediately&&m._ref.child("oAuthUsers").child(b.replace(/\./g,"")).remove(),m._firebaseApp.auth().signOut().then(function(){a.set("passportSession",""),m._callback(null,null)})},k()}})();