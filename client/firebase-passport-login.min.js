(function(){window.FirebasePassportLogin=function(a,b){"use strict";function c(a,b,c,d){let e=null==window.screenLeft?screen.left:window.screenLeft,f=null==window.screenTop?screen.top:window.screenTop,g=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,h=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,i=window.open(a,b,"scrollbars=yes, width="+c+", height="+d+", top="+(h/2-d/2+f)+", left="+(g/2-c/2+e));return window.focus&&i.focus(),i}function d(a){let b=i._ref.child(a);cookie.set("passportAnonymous",i._anonymousUid,{secure:0===document.location.href.indexOf("https")}),console.log("listening for firebase auth token at "+b.toString()),b.on("value",function(a){let c,d=a.val();try{c=JSON.parse(d)}catch(a){console.log("Error parsing payload: "+(a.message||"unknown"))}if(c&&c.token){console.log("auth token snapshot: "+c.token),cookie.remove("passportAnonymous"),b.off(),b.remove();try{i._oAuthWindow.close()}catch(a){console.error(a)}e(c)}})}function e(a){return a&&a.token?i._firebaseApp.auth().signOut().then(function(){return i._firebaseApp.auth().signInWithCustomToken(a.token)}).then(function(){let b=a.user;b&&(b[b.provider]={cachedUserProfile:JSON.parse(b.thirdPartyUserData)},b.token=a.token,b.thirdPartyUserData=void 0,i._removeTokensImmediately?cookie.set("passportSession",""):cookie.set("passportSession",a.token),i._callback(null,b))}).catch(function(a){"EXPIRED_TOKEN"===a.code&&cookie.set("passportSession",""),i._callback(a)}):void 0}function f(a){return i._tokenPath+"/"+a}function g(){return i._firebaseApp.auth().signOut().then(function(){return i._firebaseApp.auth().signInAnonymously()}).then(function(a){let b=a.user;if(b)return b.uid}).catch(function(){throw new Error("Anonymous login failed. Make sure Anonymous login is enabled in your Firebase")})}function h(a){let b;try{b=JSON.parse(a.data)}catch(a){}b&&"init"===b.type&&(b.redirect&&(i._redirectURL=b.redirect),i.startAnonymousAuthConnection())}const i=this;i._authConfig=a,i._firebaseApp=a.firebaseApp||firebase.initializeApp(a.firebaseConfig),i._firebaseDB=i._firebaseApp.database(),i._firebaseURL=a.firebaseConfig.databaseURL,i._ref=i._firebaseDB.ref(),i._tokenPath="oAuth/login",i._oAuthServerURL=a.authURL,i._oAuthServerWindow={width:1024,height:650},i._callback=b,i._ready=!0,i._redirectURL=null,i._removeTokensImmediately=!0,i.startAnonymousAuthConnection=function(){return g().then(function(a){i._anonymousUid=a}).catch(console.error)},i.login=function(a){i._provider=a,Promise.resolve(i._anonymousUid).then(function(a){return a?a:g()}).then(function(a){let b=f(a);d(b);let e=i._oAuthServerURL+i._provider+"?oAuthTokenPath="+b+"&redirect="+encodeURIComponent(i._redirectURL);i._firebaseURL&&(e+="&firebaseURL="+encodeURIComponent(i._firebaseURL)),i._oAuthWindow=c(e,"_blank",i._oAuthServerWindow.width,i._oAuthServerWindow.height)})},i.logout=function(){let a=cookie.get("passportSession");a&&i._ref.child("oAuthUsers").child(a.replace(/\./g,"")).remove(),i._firebaseApp.auth().signOut().then(function(){cookie.set("passportSession",""),i._callback(null,null)})},!function(b,d){var a=function(){return a.get.apply(a,arguments)},g=a.utils={isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isPlainObject:function(a){return!!a&&"[object Object]"===Object.prototype.toString.call(a)},toArray:function(a){return Array.prototype.slice.call(a)},getKeys:Object.keys||function(a){var b=[],c="";for(c in a)a.hasOwnProperty(c)&&b.push(c);return b},escape:function(a){return(a+"").replace(/[,;"\\=\s%]/g,function(a){return encodeURIComponent(a)})},retrieve:function(a,b){return null==a?b:a}};a.defaults={},a.expiresMultiplier=86400,a.set=function(e,h,i){if(g.isPlainObject(e))for(var j in e)e.hasOwnProperty(j)&&this.set(j,e[j],h);else{i=g.isPlainObject(i)?i:{expires:i};var k=i.expires===d?this.defaults.expires||"":i.expires,m=typeof k;"string"==m&&""!==k?k=new Date(k):"number"==m&&(k=new Date(+new Date+1e3*this.expiresMultiplier*k)),""!==k&&"toGMTString"in k&&(k=";expires="+k.toGMTString());var a=i.path||this.defaults.path;a=a?";path="+a:"";var n=i.domain||this.defaults.domain;n=n?";domain="+n:"";var o=i.secure||this.defaults.secure?";secure":"";b.cookie=g.escape(e)+"="+g.escape(h)+k+a+n+o}return this},a.remove=function(a){a=g.isArray(a)?a:g.toArray(arguments);for(var b=0,c=a.length;b<c;b++)this.set(a[b],"",-1);return this},a.empty=function(){return this.remove(g.getKeys(this.all()))},a.get=function(b,c){c=c||d;var e=this.all();if(g.isArray(b)){for(var f,h={},i=0,j=b.length;i<j;i++)f=b[i],h[f]=g.retrieve(e[f],c);return h}return g.retrieve(e[b],c)},a.all=function(){if(""===b.cookie)return{};for(var a,c=b.cookie.split("; "),d={},e=0,f=c.length;e<f;e++)a=c[e].split("="),d[decodeURIComponent(a[0])]=decodeURIComponent(a[1]);return d},a.enabled=function(){if(navigator.cookieEnabled)return!0;var b="_"===a.set("_","_").get("_");return a.remove("_"),b},"function"==typeof define&&define.amd?define(function(){return a}):"undefined"==typeof exports?window.cookie=a:exports.cookie=a}(document),function(){let a=i._firebaseApp.auth().currentUser;a&&(console.log({curUser:a},"FirebasePassportLogin._init()"),i._callback(null,{token:a.getIdToken(),provider:a.providerData,uid:a.uid})),window.addEventListener("message",h)}()}})();